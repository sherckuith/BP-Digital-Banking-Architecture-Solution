```mermaid

sequenceDiagram
    autonumber
    participant UI as SPA / Mobile
    participant BFF as BFF Web/Mobile
    participant Auth as Auth Service (DPoP)
    participant Txn as Transaction Service
    participant Core as Core Legacy
    participant Fraud as Fraud Detection
    participant Outbox as Outbox DB
    participant Kafka as Kafka (txn events)
    participant Notify as Notification Orchestrator
    participant Audit as Audit Service

    Note over UI, Auth: Seguridad y Validación
    UI->>BFF: POST /transfer (Idempotency-Key)
    BFF->>Auth: Bearer token validation (DPoP)
    Auth-->>BFF: OK
    
    Note over BFF, Core: Procesamiento en Core
    BFF->>Txn: Transfer request
    Txn->>Core: Reserve funds (debit)
    Core-->>Txn: Ack
    
    Note over Txn, Fraud: Evaluación de Riesgo MLaaS
    Txn->>Fraud: Risk evaluation
    alt Risk > MTU / anomalies
        Fraud-->>Txn: MFA step-up required
        BFF->>UI: Prompt OTP (push / SMS)
        UI->>BFF: OTP
        BFF->>Txn: OTP validated
    end
    
    Txn->>Core: Commit credit (beneficiary)
    Core-->>Txn: Confirm
    
    Note over Txn, Outbox: Persistencia Atómica (Outbox Pattern)
    Txn->>Outbox: Persist event (transaction-completed)
    
    Note over Outbox, Kafka: Publicación Asíncrona
    Outbox->>Kafka: Publish txn-events
    
    par Consumidores de Eventos
        Kafka->>Notify: txn-events
        Notify->>FCM: Push notification
        Notify->>Twilio: WhatsApp/SMS fallback (No ACK)
    and
        Kafka->>Audit: Consume event
        Audit->>Ledger: Append-only entry + hash-chain
    end
    
    Txn-->>BFF: Transfer OK (status)
    BFF-->>UI: 200 OK + transaction receipt


```